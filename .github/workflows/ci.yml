name: CI

on:
  push:
    branches: [master, staging]
  pull_request:
    branches: [master, staging]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    name: tests
    steps:
      - uses: actions/checkout@v2
        with:
          # Help Codecov detect commit SHA
          fetch-depth: 2
      - uses: actions/setup-node@v2
        with:
          node-version: 15
      - name: ðŸ“¦ Install Dependencies
        run: yarn install --immutable --immutable-cache
      - name: ðŸ§ª Run Tests
        run: yarn test -- --single-run
      - name: Codecov
        run: bash <(curl -s https://codecov.io/bash)
  eslint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 15
      - name: ðŸ“¦ Install Dependencies
        run: yarn install --immutable --immutable-cache
      - name: ðŸ’¨ ESLint
        run: yarn lint
  typescript:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 15
      - name: ðŸ“¦ Install Dependencies
        run: yarn install --immutable --immutable-cache
      - name: âœ… TypeScript lint
        run: yarn lint:ts
  prettier:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 15
      - name: ðŸ“¦ Install Dependencies
        run: yarn install --immutable --immutable-cache
      - name: ðŸ’… Prettier Check
        run: yarn prettier:check
  yarn-check-cache:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 15
      - name: ðŸ“¦ Install Dependencies
        run: yarn install --immutable --immutable-cache --check-cache
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref == 'refs/heads/master' && 'production' || 'staging' }}
    needs: [test, eslint, typescript, prettier]
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 15
      - name: ðŸ“¦ Install Dependencies
        run: yarn install --immutable --immutable-cache
      - name: ðŸ”¨ Build
        run: yarn build
        env:
          ROLLBAR_ACCESS_TOKEN: ${{ secrets.ROLLBAR_ACCESS_TOKEN }}
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE }}
      - name: ðŸš€ Deploy to S3 Production
        if: github.ref == 'refs/heads/master'
        run: |
          aws s3 sync dist s3://cru-ert-web-prod --region us-east-1 --acl public-read --exclude '*.html' --cache-control 'public, max-age=31536000',
          aws s3 sync dist s3://cru-ert-web-prod --region us-east-1 --acl public-read --include '*.html' --cache-control 'public, max-age=180'
      - name: ðŸš€ Deploy to S3 Staging
        if: github.ref == 'refs/heads/staging'
        run: |
          aws s3 sync dist s3://cru-ert-web-stage --region us-east-1 --acl public-read --exclude '*.html' --cache-control 'public, max-age=31536000' --delete,
          aws s3 sync dist s3://cru-ert-web-stage --region us-east-1 --acl public-read --include '*.html' --cache-control 'public, no-cache' --delete
