<div class="edit-box-name crsQuestion">
  <div class="btn-group btn-group-xs pull-right" role="group">
    <button class="btn btn-warning btn-disabled" ng-if="block.adminOnly" ng-click="toggleBlockEdit('advanced')">
      <i class="fa fa-lock"></i> <translate>Admin only</translate>
    </button>
    <button class="btn btn-default" ng-click="toggleBlockEdit('advanced')" ng-if="!block.adminOnly && visibleRegTypesArray.length < conference.registrantTypes.length">
      <i class="fa fa-eye"></i>
      <ng-pluralize count="visibleRegTypesArray.length" offset=2
          when="{'0': 'None',
           '1': '{{registrationTypeName(visibleRegTypesArray[0])}}',
           '2': '{{registrationTypeName(visibleRegTypesArray[0])}} & {{registrationTypeName(visibleRegTypesArray[1])}}',
           'one': '{{registrationTypeName(visibleRegTypesArray[0])}}, {{registrationTypeName(visibleRegTypesArray[1])}} & one more',
           'other': '{{registrationTypeName(visibleRegTypesArray[0])}}, {{registrationTypeName(visibleRegTypesArray[1])}} & {} more'}">
      </ng-pluralize>
    </button>
    <button ng-if="!editBlock" class="btn btn-default" ng-click="toggleBlockEdit()"><i class="fa fa-pencil-square-o"></i> <translate>Edit</translate></button>
    <button ng-if="editBlock" class="btn btn-default" ng-click="toggleBlockEdit()"><i class="fa fa-check-square-o"></i> <translate>Close</translate></button>
    <button class="btn btn-default" ng-click="copyBlock(block.id);"><i class="fa fa-clipboard"></i> <translate>Copy</translate></button>
    <button class="btn btn-danger" ng-click="deleteBlock(block.id, true)" ng-disabled="!canDelete"><i class="fa fa-trash-o"></i> <translate>Delete</translate></button>
    <span class="btn btn-default" ui-tree-handle><i class="fa fa-bars"></i> <translate>Move</translate></span>
  </div>
  <label><span ng-bind-html="block.title"></span><em class="required" ng-show="block.required">*</em></label>
  <ng-switch on="block.type">
    <p ng-switch-when="paragraphContent" ng-bind-html="block.content.paragraph" class="display-linebreaks"></p>
    <text-question block="block" ng-switch-when="textQuestion"></text-question>
    <textarea-question block="block" ng-switch-when="textareaQuestion"></textarea-question>
    <radio-question block="block" ng-switch-when="radioQuestion"></radio-question>
    <checkbox-question block="block" ng-switch-when="checkboxQuestion"></checkbox-question>
    <phone-question block="block" ng-switch-when="phoneQuestion"></phone-question>
    <email-question block="block" ng-switch-when="emailQuestion"></email-question>
    <select-question block="block" ng-switch-when="selectQuestion"></select-question>
    <name-question block="block" ng-switch-when="nameQuestion"></name-question>
    <address-question block="block" ng-switch-when="addressQuestion"></address-question>
    <number-question block="block" ng-switch-when="numberQuestion" class="form-group"></number-question>
    <gender-question block="block" ng-switch-when="genderQuestion"></gender-question>
    <date-question block="block" ng-switch-when="dateQuestion"></date-question>
    <year-in-school-question block="block" ng-switch-when="yearInSchoolQuestion"></year-in-school-question>
  </ng-switch>

  <div class="edit-options" ng-if="editBlock">
    <!-- Tab panes -->
    <tabset>
      <tab heading="Options">
        <div class="form-group popup-custom-width">
          <label class="inline-label" translate>Title</label>
          <i popover-template="popup.titleTemplateUrl"
             popover-trigger="mouseenter"
             popover-placement="right"
             class="fa fa-question-circle question-popover">
          </i>
          <input type="text" class="form-control field-label" placeholder="Label" ng-model="block.title">
        </div>

        <div class="form-group popup-custom-width" ng-if="block.type === 'paragraphContent'">
          <label class="inline-label" translate>Description</label>
          <i popover-template="popup.titleTemplateUrl"
             popover-trigger="mouseenter"
             popover-placement="right"
             class="fa fa-question-circle question-popover">
          </i>
          <textarea ng-model="block.content.paragraph" class="form-control" style="height:400px;"></textarea>
        </div>
        <div class="form-group" ng-if="hasOptions">
          <label translate>Possible Answers</label>
          <div ng-repeat="choice in block.content.choices track by $index" class="spacing-below-xs">
            <div class="input-group">
              <input ng-model="block.content.choices[$index].value" type="text" class="form-control" ng-keyup="onChoiceOptionChange()">
                      <span class="input-group-btn">
                        <button type="button" class="btn btn-primary" ng-click="editBlockOptionMoveUp($index)" ng-disabled="$first"><span class="glyphicon glyphicon-arrow-up"></span></button>
                        <button type="button" class="btn btn-primary" ng-click="editBlockOptionMoveDown($index)" ng-disabled="$last"><span class="glyphicon glyphicon-arrow-down"></span></button>
                        <button type="button" class="btn" ng-click="editBlockOptionAdvanced($index)"><span class="glyphicon glyphicon-cog"></span><span class="hidden-xs hidden-sm"> <translate>Options</translate></span></button>
                        <button type="button" class="btn btn-danger" ng-click="editBlockDeleteOption($index)"><span class="glyphicon glyphicon-trash"></span><span class="hidden-xs hidden-sm"> <translate>Delete</translate></span></button>
                      </span>
            </div>
          </div>

          <div class="input-group spacing-above-md">
            <input ng-model="editBlockAddOptionValue" type="text" placeholder="New Answer" class="form-control" ng-enter="editBlockAddOption(editBlockAddOptionValue); editBlockAddOptionValue='';">
                  <span class="input-group-btn">
                    <button type="button" class="btn btn-success" ng-click="editBlockAddOption(editBlockAddOptionValue); editBlockAddOptionValue='';"><span class="glyphicon glyphicon-plus" page=""></span> <translate>Add</translate></button>
                  </span>
          </div>

          <div class="checkbox" ng-if="block.type === 'radioQuestion'">
            <label><input type="checkbox" ng-model="block.content.otherOption.enabled"> <translate>Allow custom "other" option</translate></label>
          </div>
        </div>

        <div class="checkbox" ng-if="block.type === 'yearInSchoolQuestion'">
          <label><input type="checkbox" ng-model="block.content.hideGradStudent"> <translate>Hide "Graduate Student" option</translate></label>
        </div>

        <div class="checkbox" ng-if="requiredOption && !block.adminOnly">
          <label><input type="checkbox" ng-model="block.required"> <translate>Required</translate></label>
        </div>
        <div class="checkbox" ng-if="profileOption || block.profileType">
          <label ng-class="{'green': block.profileType}"><input type="checkbox" ng-model="profileCheck" ng-change="toggleProfileType(profileCheck)" ng-disabled="!profileOption"> <i class="fa fa-user"></i> <translate>Cru Profile</translate></label>
        </div>
      </tab>
      <tab heading="Advanced" active="activeTab.advanced">
        <div class="form-group">
          <label class="inline-label" translate>Export Title</label>
          <i popover="Enter a value here to replace the question title in a registration export."
             popover-trigger="mouseenter" class="fa fa-question-circle question-popover"></i>
          <input type="text"
                 class="form-control field-label"
                 ng-model="block.exportFieldTitle" />
        </div>
		<div class="row form-group" ng-if="block.type === 'dateQuestion'">
          <label class="inline-label date-alignment pull-left" translate>Min Date</label>
          <div class="col-md-4 col-lg-3">
            <pick-a-date show-errors ng-model="block.content.range.min" ng-required="block.required" picker-max-date="block.content.range.max"></pick-a-date>
          </div>
          <label class="inline-label date-alignment pull-left col-md-offset-1" translate>Max Date</label>
          <div class="col-md-4 col-lg-3">
            <pick-a-date show-errors ng-model="block.content.range.max" ng-required="block.required" picker-min-date="block.content.range.min"></pick-a-date>
          </div>
        </div>
        <div class="row" ng-if="block.type === 'numberQuestion'">
          <div class="form-group col-sm-6 stacked-spacing-col-sm">
            <label class="control-label" translate>Min Number</label>
            <input show-errors show-errors-instant="true" type="number" class="form-control field-label" ng-model="block.content.range.min" ng-max="block.content.range.max">
            <span class="help-block help-block-hidden" translate>Number is larger than the max value of {{block.content.range.max}}</span>
          </div>
          <div class="form-group col-sm-6 stacked-spacing-col-sm">
            <label class="control-label" translate>Max Number</label>
            <input show-errors show-errors-instant="true" type="number" class="form-control field-label" ng-model="block.content.range.max" ng-min="block.content.range.min">
            <span class="help-block help-block-hidden" translate>Number is smaller than the min value of {{block.content.range.min}}</span>
          </div>
        </div>
        <div class="form-group">
          <label translate>Show this question for the following registrant types:</label>
          <div ng-if="canChangeRegTypes">
            <div class="checkbox" ng-if="block.type !== 'paragraphContent'">
              <label>
                <input type="checkbox" ng-model="block.adminOnly">
                <translate>Admin only</translate>
              </label>
              <i popover="{{'This question will be visible to admins only and will not be seen by registrants. This can be used for bookkeeping meta information like room assignments.' | translate}}"
                 popover-trigger="mouseenter" class="fa fa-question-circle question-popover"></i>
            </div>

            <div ng-repeat="type in conference.registrantTypes" ng-if="!block.adminOnly" class="checkbox">
              <label>
                <input type="checkbox" ng-model="$parent.visibleRegTypes[type.id]">
                {{type.name}}
              </label>
            </div>
          </div>
          <p ng-if="!canChangeRegTypes" class="text-muted"><i class="fa fa-exclamation-triangle"></i> <translate>This question must be shown for all registrant types.</translate></p>
        </div>
        <div class="form-group" ng-if="hasOptions">
          <label class="inline-label" translate>Expense Type</label>
          <select class="form-control" ng-model="block.expenseType" ng-options="key as value for (key , value) in expenseTypesConstants">
            <option value="" translate>None</option>
          </select>
        </div>
      </tab>
      <tab heading="Rules" ng-if="canHaveRules">
        <p class="text-muted"><i class="fa fa-info-circle"></i> <translate>Rules are a great way to hide questions based on the registrant's answers to other questions. All rules created must be met before the question is displayed.</translate>
          <translate>Rules can depend on questions of</translate> <a href="" tooltip="{{'Multiple Choice, Dropdown, Number, Date, Gender or Year in School' | translate}}" translate>these types</a> <translate>that are above this question.</translate></p>

        <div class="form-horizontal">
          <div class="form-group">
            <div class="col-md-2">
              <button class="btn btn-success" ng-click="addRule()"><i class="fa fa-plus"></i> <translate>Add Rule</translate></button>
            </div>
            <div class="col-md-8 rule-message-alignment">
              <span class="pull-left" translate>Show question if:</span>
              <div ng-repeat="choice in ['AND','OR']" class="pull-left margin-left-10 radio padding-top-0">
                <label>
                  <input type="radio" show-errors ng-model="block.content.ruleoperand" ng-value="choice">
                  <strong ng-if="choice==='AND'" translate>All rules are met</strong>
                  <strong ng-if="choice==='OR'" translate>Any rules are met</strong>
                </label>
              </div>
            </div>
          </div>

          <div ng-repeat="rule in block.rules" style="overflow: auto">
            <div class="col-md-4 stacked-spacing-col-md form-group">
              <select ng-model="rule.parentBlockId" ng-options="block.id as block.title for block in ruleBlocks()" class="form-control"></select>
            </div>
            <div class="col-md-2 col-sm-5 stacked-spacing-col-md form-group">
              <select class="form-control" ng-model="rule.operator">
                <option value="=" translate>equals</option>
                <option value="!=" translate>does not equal</option>
                <option value=">" ng-if="!ruleValues(rule.parentBlockId).length" translate>is greater than</option>
                <option value="<" ng-if="!ruleValues(rule.parentBlockId).length" translate>is less than</option>
              </select>
            </div>
            <div class="col-md-5 col-sm-7 stacked-spacing-col-md form-group" ng-switch="ruleValueInputType(rule.parentBlockId)">
              <div ng-switch-when="number">
                <input type="number"
                       class="form-control"
                       show-errors
                       show-errors-instant="true"
                       string-to-number
                       ng-model="rule.value"
                       ng-model-options="{ allowInvalid: true }"
                       ng-min="{{ruleValues(rule.parentBlockId).min}}"
                       ng-max="{{ruleValues(rule.parentBlockId).max}}" />
                <span class="help-block help-block-hidden" ng-if="ruleValues(rule.parentBlockId).min && ruleValues(rule.parentBlockId).max" translate>Please enter a number between {{ruleValues(rule.parentBlockId).min}} and {{ruleValues(rule.parentBlockId).max}}</span>
                <span class="help-block help-block-hidden" ng-if="ruleValues(rule.parentBlockId).min && !ruleValues(rule.parentBlockId).max" translate>Please enter a number greater than or equal to {{ruleValues(rule.parentBlockId).min}}</span>
                <span class="help-block help-block-hidden" ng-if="!ruleValues(rule.parentBlockId).min && ruleValues(rule.parentBlockId).max" translate>Please enter a number less than or equal to {{ruleValues(rule.parentBlockId).max}}</span>
              </div>
              <select ng-switch-when="select" show-errors ng-model="rule.value" ng-options="v for v in ruleValues(rule.parentBlockId)" class="form-control"></select>
              <select ng-switch-when="gender" show-errors ng-model="rule.value" class="form-control">
                <option value="M" translate>Male</option>
                <option value="F" translate>Female</option>
              </select>
              <pick-a-date ng-switch-when="date" show-errors ng-model="rule.value" picker-min-date="getRangeValues(rule.parentBlockId).min" picker-max-date="getRangeValues(rule.parentBlockId).max"></pick-a-date>
            </div>
            <div class="clearfix visible-sm-block"></div>
            <div class="col-md-1 text-right">
              <button class="btn btn-danger" ng-click="removeRule(rule.id)" title="Delete Rule"><i class="fa fa-trash-o"></i></button>
            </div>
          </div>
        </div>

        <div ng-if="block.type === 'checkboxQuestion'">
          <p class="text-muted"><i class="fa fa-info-circle"></i>
            <translate>This new Rules section will make the Force Selection conditional upon the rules being satisfied.</translate>
            <translate>Rules can depend on questions of</translate> <a href="" tooltip="{{'Multiple Choice, Dropdown, Number, Date, Gender or Year in School' | translate}}"
              translate>these types</a>
            <translate>that are above this question.</translate>
          </p>
          <div class="form-horizontal">
            <div class="form-group">
              <div class="col-md-2">
                <button class="btn btn-success" ng-click="addForceRule()" ng-disabled="disableForceSelectionRule()"><i class="fa fa-plus"></i> <translate>Add Rule</translate></button>
              </div>
              <div class="col-md-8 rule-message-alignment">
                <span class="pull-left" translate>Show question if:</span>
                <div ng-repeat="choice in ['AND','OR']" class="pull-left margin-left-10 radio padding-top-0">
                  <label> 
                    <input type="radio" show-errors ng-model="block.content.forceSelectionRuleOperand" ng-value="choice" ng-disabled="disableForceSelectionRule()">
                    <strong ng-if="choice==='AND'" translate>All rules are met</strong>
                    <strong ng-if="choice==='OR'" translate>Any rules are met</strong>
                  </label>
                </div>
              </div>
            </div>

            <div ng-repeat="rule in block.additionalRules" style="overflow: auto">
                <div class="col-md-4 stacked-spacing-col-md form-group">
                  <select ng-model="rule.parentBlockId" ng-options="block.id as block.title for block in ruleBlocks()" class="form-control"></select>
                </div>
                <div class="col-md-2 col-sm-5 stacked-spacing-col-md form-group">
                  <select class="form-control" ng-model="rule.operator">
                    <option value="=" translate>equals</option>
                    <option value="!=" translate>does not equal</option>
                    <option value=">" ng-if="!ruleValues(rule.parentBlockId).length" translate>is greater than</option>
                    <option value="<" ng-if="!ruleValues(rule.parentBlockId).length" translate>is less than</option>
                  </select>
                </div>
                <div class="col-md-5 col-sm-7 stacked-spacing-col-md form-group" ng-switch="ruleValueInputType(rule.parentBlockId)">
                  <div ng-switch-when="number">
                    <input type="number"
                          class="form-control"
                          show-errors
                          show-errors-instant="true"
                          string-to-number
                          ng-model="rule.value"
                          ng-model-options="{ allowInvalid: true }"
                          ng-min="{{ruleValues(rule.parentBlockId).min}}"
                          ng-max="{{ruleValues(rule.parentBlockId).max}}" />
                    <span class="help-block help-block-hidden" ng-if="ruleValues(rule.parentBlockId).min && ruleValues(rule.parentBlockId).max" translate>Please enter a number between {{ruleValues(rule.parentBlockId).min}} and {{ruleValues(rule.parentBlockId).max}}</span>
                    <span class="help-block help-block-hidden" ng-if="ruleValues(rule.parentBlockId).min && !ruleValues(rule.parentBlockId).max" translate>Please enter a number greater than or equal to {{ruleValues(rule.parentBlockId).min}}</span>
                    <span class="help-block help-block-hidden" ng-if="!ruleValues(rule.parentBlockId).min && ruleValues(rule.parentBlockId).max" translate>Please enter a number less than or equal to {{ruleValues(rule.parentBlockId).max}}</span>
                  </div>
                  <select ng-switch-when="select" ng-model="rule.value" ng-options="v for v in ruleValues(rule.parentBlockId)" class="form-control"></select>
                  <select ng-switch-when="gender" ng-model="rule.value" class="form-control">
                    <option value="M" translate>Male</option>
                    <option value="F" translate>Female</option>
                  </select>
                  <pick-a-date ng-switch-when="date" ng-model="rule.value" picker-min-date="getRangeValues(rule.parentBlockId).min" picker-max-date="getRangeValues(rule.parentBlockId).max"></pick-a-date>
                </div>
                <div class="clearfix visible-sm-block"></div>
                <div class="col-md-1 text-right">
                  <button class="btn btn-danger" ng-click="removeForceRule(rule.id)" title="Delete Rule"><i class="fa fa-trash-o"></i></button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </tab>
    </tabset>
  </div>
</div>
