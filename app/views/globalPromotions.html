<div class="container">
  <div class="row">
    <div ng-if="$ctrl.noAccess" class="col-md-12">
      <div class="alert alert-danger">
        <strong translate>Access Denied:</strong>
        <p translate>You are not a global promotions admin for any ministry.</p>
        <p translate>
          If you believe you should have access, please email
          <a href="mailto:help@cru.org">help@cru.org</a>.
        </p>
      </div>
    </div>

    <div class="col-md-12" ng-if="!$ctrl.noAccess">
      <div
        ng-if="$ctrl.showMinistrySelector"
        class="form-group margin-bottom-lg"
      >
        <label>
          <span translate>Ministry</span>
          <select
            class="form-control"
            ng-model="$ctrl.selectedMinistryId"
            ng-change="$ctrl.loadMinistryPromotions()"
            ng-options="ministry.id as ministry.name for ministry in $ctrl.ministries"
          ></select>
        </label>
      </div>

      <div ng-if="$ctrl.editingPromotion" class="margin-bottom-lg">
        <div class="panel-heading">
          <h2 class="h3">
            <span ng-if="$ctrl.editingPromotion.id" translate>
              Edit Promotion
            </span>
            <span ng-if="!$ctrl.editingPromotion.id" translate>
              New Promotion
            </span>
          </h2>
        </div>

        <div class="alert alert-info margin-bottom-md">
          This promotion will apply to all {{$ctrl.getMinistryName()}}
          conferences.
        </div>

        <promotion
          promo="$ctrl.editingPromotion"
          on-save="$ctrl.savePromotion()"
          on-discard="$ctrl.cancelEdit()"
        ></promotion>
      </div>

      <div class="promotions-header">
        <h2 translate>{{$ctrl.getMinistryName()}} Promotions</h2>
        <button
          type="button"
          class="btn btn-success"
          ng-click="$ctrl.addPromotion()"
          ng-if="!$ctrl.editingPromotion && $ctrl.promotions.length === 0"
          translate
        >
          New Promotion
        </button>
      </div>

      <div
        class="filter-row well well-full"
        ng-if="$ctrl.promotions.length > 0 && !$ctrl.editingPromotion"
      >
        <div class="filters-container">
          <div>
            <label>
              <span translate>Filter by Code</span>
            </label>
            <input
              type="text"
              class="form-control"
              ng-model="$ctrl.codeFilter"
            />
          </div>

          <div>
            <label style="display: block" translate>
              Filter by Active Status
            </label>
            <div class="btn-group" role="group">
              <button
                type="button"
                class="btn btn-default"
                ng-class="{'active': $ctrl.statusFilter === 'all'}"
                ng-click="$ctrl.setStatusFilter('all')"
                translate
              >
                All
              </button>
              <button
                type="button"
                class="btn btn-default"
                ng-class="{'active': $ctrl.statusFilter === 'active'}"
                ng-click="$ctrl.setStatusFilter('active')"
                translate
              >
                Active
              </button>
              <button
                type="button"
                class="btn btn-default"
                ng-class="{'active': $ctrl.statusFilter === 'inactive'}"
                ng-click="$ctrl.setStatusFilter('inactive')"
                translate
              >
                Inactive
              </button>
            </div>
          </div>
        </div>

        <div>
          <button
            type="button"
            class="btn btn-success"
            ng-click="$ctrl.addPromotion()"
            translate
          >
            New Promotion
          </button>
        </div>
      </div>

      <div class="table-responsive" ng-if="$ctrl.filteredPromotions.length > 0">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th scope="col">
                <button
                  class="sort-button"
                  ng-click="$ctrl.setOrder('code')"
                  aria-label="{{ 'Sort by Code' | translate }}"
                >
                  <translate>Code</translate>
                  <i
                    ng-if="$ctrl.orderByField === 'code'"
                    class="fa"
                    ng-class="{'fa-caret-down': $ctrl.reverseSort, 'fa-caret-up': !$ctrl.reverseSort}"
                    aria-hidden="true"
                  ></i>
                </button>
              </th>
              <th scope="col" class="amount-column">
                <button
                  class="sort-button"
                  ng-click="$ctrl.setOrder('amount')"
                  aria-label="{{ 'Sort by Amount' | translate }}"
                >
                  <translate>Amount</translate>
                  <i
                    ng-if="$ctrl.orderByField === 'amount'"
                    class="fa"
                    ng-class="{'fa-caret-down': $ctrl.reverseSort, 'fa-caret-up': !$ctrl.reverseSort}"
                    aria-hidden="true"
                  ></i>
                </button>
              </th>
              <th scope="col">
                <button
                  class="sort-button"
                  ng-click="$ctrl.setOrder('status')"
                  aria-label="{{ 'Sort by Status' | translate }}"
                >
                  <translate>Status</translate>
                  <i
                    ng-if="$ctrl.orderByField === 'status'"
                    class="fa"
                    ng-class="{'fa-caret-down': $ctrl.reverseSort, 'fa-caret-up': !$ctrl.reverseSort}"
                    aria-hidden="true"
                  ></i>
                </button>
              </th>
              <th scope="col">
                <button
                  class="sort-button"
                  ng-click="$ctrl.setOrder('activationDate')"
                  aria-label="{{ 'Sort by Start Date' | translate }}"
                >
                  <translate>Start Date</translate>
                  <i
                    ng-if="$ctrl.orderByField === 'activationDate'"
                    class="fa"
                    ng-class="{'fa-caret-down': $ctrl.reverseSort, 'fa-caret-up': !$ctrl.reverseSort}"
                    aria-hidden="true"
                  ></i>
                </button>
              </th>
              <th scope="col">
                <button
                  class="sort-button"
                  ng-click="$ctrl.setOrder('deactivationDate')"
                  aria-label="{{ 'Sort by End Date' | translate }}"
                >
                  <translate>End Date</translate>
                  <i
                    ng-if="$ctrl.orderByField === 'deactivationDate'"
                    class="fa"
                    ng-class="{'fa-caret-down': $ctrl.reverseSort, 'fa-caret-up': !$ctrl.reverseSort}"
                    aria-hidden="true"
                  ></i>
                </button>
              </th>
              <th scope="col">
                <button
                  class="sort-button"
                  ng-click="$ctrl.setOrder('description')"
                  aria-label="{{ 'Sort by Description' | translate }}"
                >
                  <translate>Description</translate>
                  <i
                    ng-if="$ctrl.orderByField === 'description'"
                    class="fa"
                    ng-class="{'fa-caret-down': $ctrl.reverseSort, 'fa-caret-up': !$ctrl.reverseSort}"
                    aria-hidden="true"
                  ></i>
                </button>
              </th>
              <th scope="col">
                <button
                  class="sort-button"
                  ng-click="$ctrl.setOrder('ministryActivityId')"
                  aria-label="{{ 'Sort by Activity' | translate }}"
                >
                  <translate>Activity</translate>
                  <i
                    ng-if="$ctrl.orderByField === 'ministryActivityId'"
                    class="fa"
                    ng-class="{'fa-caret-down': $ctrl.reverseSort, 'fa-caret-up': !$ctrl.reverseSort}"
                    aria-hidden="true"
                  ></i>
                </button>
              </th>
              <th scope="col" translate>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr
              ng-repeat="promotion in $ctrl.filteredPromotions | orderBy:$ctrl.sortField:$ctrl.reverseSort"
            >
              <td>
                <strong>{{promotion.code}}</strong>
              </td>
              <td>{{promotion.amount | localizedCurrency:'USD'}}</td>
              <td>
                <span
                  class="label status-label"
                  ng-class="$ctrl.isActive(promotion) ? 'label-success' : 'label-danger'"
                >
                  <span translate>
                    {{$ctrl.isActive(promotion) ? 'Active' : 'Inactive'}}
                  </span>
                </span>
              </td>
              <td>{{$ctrl.formatDate(promotion.activationDate)}}</td>
              <td>
                <span ng-if="promotion.deactivationDate">
                  {{$ctrl.formatDate(promotion.deactivationDate)}}
                </span>
                <span
                  ng-if="!promotion.deactivationDate"
                  class="text-muted"
                  translate
                >
                  No end date
                </span>
              </td>
              <td>{{promotion.description}}</td>
              <td>{{$ctrl.getActivityName(promotion.ministryActivityId)}}</td>
              <td>
                <button
                  type="button"
                  class="btn btn-default btn-sm"
                  ng-click="$ctrl.editPromotion(promotion)"
                  ng-disabled="$ctrl.editingPromotion"
                  title="Edit"
                  translate
                >
                  Edit
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div
        ng-if="$ctrl.promotions.length === 0 && !$ctrl.editingPromotion"
        class="alert alert-info"
      >
        {{$ctrl.getMinistryName()}}
        <span translate>
          doesn't have any promotions yet. Click the "New Promotion" button to
          create one.
        </span>
      </div>
      <div
        ng-if="$ctrl.promotions.length > 0 && $ctrl.filteredPromotions.length === 0 && !$ctrl.editingPromotion"
        class="alert alert-info"
      >
        <span translate>
          No promotions found matching the filter criteria. Try changing the
          filter.
        </span>
      </div>
    </div>
  </div>
</div>
